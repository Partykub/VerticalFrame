# Auto-Reframe Focus Logic Guide

เอกสารนี้อธิบายตรรกะการตัดสินใจ (Decision Logic) ของระบบ Auto-Reframe ว่าในแต่ละสถานการณ์ ระบบเลือก "จุดโฟกัส" (Camera Focus Point) อย่างไร

---

## 1. ลำดับความสำคัญ (The Hierarchy)

ระบบจะตัดสินใจเลือกเป้าหมายตามลำดับความสำคัญ (Priority) ดังนี้:

| ลำดับ | ประเภทเป้าหมาย | เงื่อนไข | จุดโฟกัส (Composition) |
| :--- | :--- | :--- | :--- |
| **1** | **Face** (ใบหน้า) | มีความคมชัด > `min_sharpness` | **กึ่งกลาง**ใบหน้า |
| **2** | **Body** (ตัวคน) | เมื่อไม่เจอใบหน้า | **ส่วนบนของร่างกาย** (30% จากหัว) เพื่อเน้น Head & Shoulders |
| **3** | **Saliency** (จุดเด่น) | เมื่อไม่เจอคนเลย | จุดที่ AI มองว่าเป็น **"จุดเด่นที่สุด"** ในภาพ |
| **4** | **Center** (กึ่งกลาง) | เมื่อไม่เจออะไรเลย | กึ่งกลางเฟรมเดิม (Safe Mode) |

---

## 2. กรณีเจอหลายเป้าหมาย (Multiple Targets)

หากในฉากมีวัตถุประเภทเดียวกันหลายชิ้น ระบบต้องเลือก **"ผู้ชนะ"** เพียงหนึ่งเดียว:

### 2.1 หลายใบหน้า (Multiple Faces)
*   **กฎการเลือก:** เลือกใบหน้าที่มี **ขนาดใหญ่ที่สุด** (Largest Area)
    *   *เหตุผล:* สมมติว่าคนอยู่ใกล้กล้องหรือเป็นตัวเอกมักจะมีขนาดหน้าใหญ่กว่าตัวประกอบ
*   **Target Point:** กึ่งกลาง Bounding Box ของหน้า

### 2.2 หลายตัวคน (Multiple Bodies)
*   **กฎการเลือก:** เลือกตัวคนที่มี **ขนาดใหญ่ที่สุด**
*   **Target Point:** ตำแหน่ง 30% จากขอบบนของกรอบตัว (เน้นช่วงอก-หัว ไม่ใช่สะดือ)

---

## 3. ระบบล็อคเป้าหมาย (Smart Lock Logic)

เพื่อให้กล้องนิ่งและดูเป็นมืออาชีพ ระบบจะไม่เปลี่ยนเป้าหมายไปมาตามใจชอบทันที แต่มีกฎ **Smart Lock** ดังนี้:

### 3.1 การรักษาสถานะ (Holding Lock)
*   เมื่อเลือก `ID: X` แล้ว ระบบจะ **จำ** ID นั้นไว้
*   แม้จะมี `ID: Y` (ที่เป็นประเภทเดียวกัน) เดินผ่านหน้า กล้องจะ **ไม่สนใจ** และยังคงถ่าย `ID: X` ต่อไป
*   **ข้อดี:** ป้องกันกล้องส่ายไปมาเวลาคนเดินสวนกัน

### 3.2 การแย่งชิงตำแหน่ง (Switching / Stealing)
เป้าหมายใหม่จะแย่งความสนใจได้ใน 2 กรณี:

1.  **กรณี Upgrade (Priority Override) *[สำคัญ]*:**
    *   **สถานการณ์:** กล้อง Lock **Body** อยู่ -> จู่ๆ มี **Face** โผล่มา
    *   **การตัดสินใจ:** **เปลี่ยนทันที!** (Force Switch)
    *   *เหตุผล:* หน้าคนสำคัญกว่าตัวคนเสมอ

2.  **กรณีอนาคตมั่นคง (Future Look-Ahead):**
    *   **สถานการณ์:** กล้อง Lock **Face A** อยู่ -> มี **Face B** โผล่มา
    *   **การตัดสินใจ:** ระบบจะมองไปในอนาคต (เช่น 60 เฟรมข้างหน้า)
        *   ถ้า Face B อยู่นานกว่าและเด่นกว่า Face A จริงๆ -> **เปลี่ยนไปหา Face B**
        *   ถ้า Face B โผล่มาแวบเดียวและหายไป -> **ยังคงถ่าย Face A ต่อ** (ถือว่าเป็นตัวประกอบเดินผ่าน)

### 3.3 กรณีเป้าหมายหาย (Lost Target)
*   ถ้า `ID: X` หลุดเฟรมหรือถูกบัง:
    *   ระบบจะ **"รอ" (Grace Period)** ประมาณ 30 เฟรม (1 วินาที)
    *   ถ้ากลับมาทัน -> ล็อคต่อเหมือนเดิม
    *   ถ้าไม่กลับมา -> ปล่อย Lock แล้วเริ่มหาเป้าหมายใหม่อีกครั้ง

---

## 4. สรุปพฤติกรรมในสถานการณ์ต่างๆ

| สถานการณ์ | พฤติกรรมกล้อง |
| :--- | :--- |
| **คนยืนคุยกัน 2 คน** | ถ่ายคนที่ **"หน้าใหญ่กว่า"** (อยู่ใกล้กล้องกว่า/หันหน้ามาตรงกว่า) |
| **คนหันหลัง (เห็นแต่ตัว)** | ถ่าย Body (ช่วงไหล่) |
| **คนหันหลัง แล้วหันหน้ามา** | เปลี่ยนจากโฟกัส Body -> โฟกัส Face ทันที |
| **คนเดินสวนกัน** | ถ่ายคนเดิมต่อเนื่อง ไม่วอกแวกตามคนเดินตัดหน้า |
| **ถ่ายวิว/ของวางอยู่** | ใช้ Saliency จับจุดที่เด่นที่สุด (เช่น จานอาหาร, แจกัน) |
| **ขอบจอดำ/ตัวหนังสือวิ่ง** | Saliency จะพยายามหลบขอบจอ (Border Masking 15%) เพื่อไม่ให้ไปโฟกัสขยะขอบจอ |

---
*Logic นี้ถูก implement อยู่ใน `Director.select_target` และ `VideoAnalyzer.analyze`*
